---
title: "Water Potability"
author: "Alicia Key"
date: "2022-08-12"
output: html_document
---

# Water potability modeling

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Required libraries and random seed

### Required libraries

```{r}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(rsample)
library(parsnip)
library(yardstick)
library(broom)
library(ggplot2)
library(tune)
library(recipes)
```

### Random seed

```{r}
set.seed(123)
```

## Initial data load

```{r}
water <- read_csv("data/water_potability.csv")
knitr::kable(head(water))
```

## Feature engineering

### Visualizing number of missing values.

Modified from [https://towardsdatascience.com/missing-value-visualization-with-tidyverse-in-r-a9b0fefd2246](https://towardsdatascience.com/missing-value-visualization-with-tidyverse-in-r-a9b0fefd2246)

```{r}
water_total_rows = nrow(water)

water_missing <- water %>%
  pivot_longer(everything(), names_to = "name", values_to = "value") %>%
  mutate(is_missing = is.na(value)) %>%
  group_by(name, is_missing) %>%
  summarize(num_missing = n()) %>%
  filter(is_missing) %>%
  transmute(
    percent_missing = num_missing / water_total_rows * 100
  ) %>%
  rename(variable = name) %>%
  arrange(desc(percent_missing))

knitr::kable(water_missing)
```

```{r}
ggplot(water_missing, aes(x = variable, y = percent_missing)) +
  geom_col()
```

### Turn potability into a factor

Call the factor `potable`. The event of interest, potable water, is the first level of the factor.

```{r}
water_2 <- water %>%
  mutate(potable = factor(
      case_when(
        Potability == 0 ~ "not potable",
        Potability == 1 ~ "potable"
      ),
      levels = c("potable", "not potable")
    )
  ) %>%
  select(-Potability)

knitr::kable(head(water_2))
```

### Train test split

```{r}
water_split <- initial_split(water_2, prop = 0.75, strata = potable)

water_train <- water_split %>%
  training()

water_test <- water_split %>%
  testing()
```

### Recipe to preprocess values

- Handle missing values with kNN

```{r}
clean_water_recipe <- recipe(potable ~ ., data = water_train) %>%
  step_impute_knn(all_predictors(), neighbors = 5)

clean_water_prep <- clean_water_recipe %>%
  prep(training = water_train)

clean_water_train <- clean_water_prep %>%
  bake(new_data = NULL)

clean_water_test <- clean_water_prep %>%
  bake(new_data = water_test)
```
